<link rel="stylesheet" href="/css/book.css">

<div class="row book">

    <div class="col-sm-5">
        <h3 class="text-center pb-4">SERVICE</h3>
		<div class="d-flex align-items-start">
            <div class="nav flex-column nav-pills me-1" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                <button class="nav-link active" id="v-pills-dog-tab" data-bs-toggle="pill" data-bs-target="#v-pills-dog" type="button" role="tab" aria-controls="v-pills-dog" aria-selected="true">Dog</button>
                <button class="nav-link" id="v-pills-cat-tab" data-bs-toggle="pill" data-bs-target="#v-pills-cat" type="button" role="tab" aria-controls="v-pills-cat" aria-selected="false">Cat</button>
                <button class="nav-link" id="v-pills-other-tab" data-bs-toggle="pill" data-bs-target="#v-pills-other" type="button" role="tab" aria-controls="v-pills-other" aria-selected="false">Other Pets</button>
            </div>
            <div class="tab-content" id="v-pills-tabContent">
                <div class="tab-pane fade show active" id="v-pills-dog" role="tabpanel" aria-labelledby="v-pills-dog-tab">
                    {{!-- <div class="row service-item p-1" >
                        <div class="col-md-10 px-1">Activity Exercise</div>
                        <div class="col-md-2 px-1 py-0 d-flex justify-content-center align-items-center">
                            <button type="button" class="btn p-0 btn-add"  id = "Activity Exercise(Dog)" onClick="reply_click(this.id)">Add</button>
                        </div>
                    </div>

                    <div class="row service-item p-1">
                        <div class="col-md-10 px-1">Pet Grooming</div>
                        <div class="col-md-2 px-1 d-flex justify-content-center align-items-center">
                            <button type="button" class="btn p-0 btn-add" id = "Pet Grooming(Dog)" onClick="reply_click(this.id)">Add</button>
                        </div>
                    </div>

                    <div class="row service-item p-1">
                        <div class="col-md-10 px-1">Pet Boarding</div>
                        <div class="col-md-2 px-1 d-flex justify-content-center align-items-center">
                            <button type="button" class="btn p-0 btn-add" id = "Pet Boarding(Dog)" onClick="reply_click(this.id)">Add</button>
                        </div>
                    </div>

                    <div class="row service-item p-1">
                        <div class="col-md-10 px-1">Tick Treatments</div>
                        <div class="col-md-2 px-1 d-flex justify-content-center align-items-center">
                            <button type="button" class="btn p-0 btn-add" id = "Tick Treatments(Dog)" onClick="reply_click(this.id)">Add</button>
                        </div>
                    </div>

                    <div class="row service-item p-1">
                        <div class="col-md-10 px-1">Ear Plucking</div>
                        <div class="col-md-2 px-1 d-flex justify-content-center align-items-center">
                            <button type="button" class="btn p-0 btn-add" id = "Ear Plucking(Dog)" onClick="reply_click(this.id)">Add</button>
                        </div>
                    </div>
                    <div class="row service-item p-1">
                        <div class="col-md-10 px-1">Sefl-Serve Wash</div>
                        <div class="col-md-2 px-1 d-flex justify-content-center align-items-center">
                            <button type="button" class="btn p-0 btn-add" id = "Sefl-Serve Wash(Dog)" onClick="reply_click(this.id)">Add</button>
                        </div>
                    </div> --}}
                </div>
                <div class="tab-pane fade" id="v-pills-cat" role="tabpanel" aria-labelledby="v-pills-cat-tab">
                    {{!-- <div class="row service-item p-1" >
                        <div class="col-md-10 px-1">Activity Exercise</div>
                        <div class="col-md-2 px-1 py-0 d-flex justify-content-center align-items-center">
                            <button type="button" class="btn p-0 btn-add"  id = "Activity Exercise(Cat)" onClick="reply_click(this.id)">Add</button>
                        </div>
                    </div>

                    <div class="row service-item p-1">
                        <div class="col-md-10 px-1">Pet Grooming</div>
                        <div class="col-md-2 px-1 d-flex justify-content-center align-items-center">
                            <button type="button" class="btn p-0 btn-add" id = "Pet Grooming(Cat)" onClick="reply_click(this.id)">Add</button>
                        </div>
                    </div>

                    <div class="row service-item p-1">
                        <div class="col-md-10 px-1">Pet Boarding</div>
                        <div class="col-md-2 px-1 d-flex justify-content-center align-items-center">
                            <button type="button" class="btn p-0 btn-add" id = "Pet Boarding(Cat)" onClick="reply_click(this.id)">Add</button>
                        </div>
                    </div>

                    <div class="row service-item p-1">
                        <div class="col-md-10 px-1">Tick Treatments</div>
                        <div class="col-md-2 px-1 d-flex justify-content-center align-items-center">
                            <button type="button" class="btn p-0 btn-add" id = "Tick Treatments(Cat)" onClick="reply_click(this.id)">Add</button>
                        </div>
                    </div>

                    <div class="row service-item p-1">
                        <div class="col-md-10 px-1">Ear Plucking</div>
                        <div class="col-md-2 px-1 d-flex justify-content-center align-items-center">
                            <button type="button" class="btn p-0 btn-add" id = "Ear Plucking(Cat)" onClick="reply_click(this.id)">Add</button>
                        </div>
                    </div>
                    <div class="row service-item p-1">
                        <div class="col-md-10 px-1">Sefl-Serve Wash</div>
                        <div class="col-md-2 px-1 d-flex justify-content-center align-items-center">
                            <button type="button" class="btn p-0 btn-add" id = "Sefl-Serve Wash(Cat)" onClick="reply_click(this.id)">Add</button>
                        </div>
                    </div> --}}
                </div>
                <div class="tab-pane fade" id="v-pills-other" role="tabpanel" aria-labelledby="v-pills-other-tab">
                    {{!-- <div class="row service-item p-1">
                        <div class="col-md-10 px-1">Pet Grooming</div>
                        <div class="col-md-2 px-1 d-flex justify-content-center align-items-center">
                            <button type="button" class="btn p-0 btn-add" id = "Pet Grooming(Other pets)" onClick="reply_click(this.id)">Add</button>
                        </div>
                    </div>

                    <div class="row service-item p-1">
                        <div class="col-md-10 px-1">Pet Boarding</div>
                        <div class="col-md-2 px-1 d-flex justify-content-center align-items-center">
                            <button type="button" class="btn p-0 btn-add" id = "Pet Boarding(Other Pets)" onClick="reply_click(this.id)">Add</button>
                        </div>
                    </div> --}}
                </div>
            </div>
        </div>
    </div>
    <form class="col-sm-7 form-book">
	    <h3 class="text-center pb-4">BOOK</h3>

        <div class="row">
            <div class="col-sm-6 form-group">
                <input class="form-control" id="name" name="name" placeholder="Name " type="text" value="{{user.fullname}}">
                <div class="inputNameError text-error"></div>
            </div>
            <div class="col-sm-6 form-group">
                <input class="form-control" id="phone" name="phone" placeholder="Phone" type="text" value="{{user.phone}}" onkeypress="return isNumber(event)" onpaste="return false;">
                <div class="inputPhoneError text-error"></div>
            </div>
        </div>
        <div class="mt-3 form-group row">
            <div class="col-sm-6">
                <input class="form-control" id="email" name="email" placeholder="Email" type="email" value="{{user.mail}}">
                <div class="inputMailError text-error"></div>
            </div>
            <div class="col-sm-6 appointment">
                <input type="datetime-local" class="px-2" id="appointment" name="appointment">
                <div class="inputAppointmentError text-error"></div>
            </div>          
        </div>

        <table class="table mt-3 service-table" name = "serviceTable">
            <thead>
                <tr>
                <th scope="col">#</th>
                <th scope="col" style="width: 60%">Service</th>
                <th scope="col">Amount</th>
                </tr>
            </thead>
            <tbody>
                {{!-- <tr>
                <th scope="row">1</th>
                <td>Grooming</td>
                <td>
                    <div class="buttons_added border-none">
                        <input aria-label="quantity" class="input-qty" max="10" min="0" name="" type="number" value="1">
                    </div>
                </td>
                </tr>
 --}}
            </tbody>
        </table>
        <div class="serviceTableError text-error text-end"></div>


        <div>
            <textarea class="form-control mt-3" id="comments" name="note" placeholder="Note" rows="4"></textarea><br>
        </div>
        <div class="d-flex justify-content-end">
            <button type="button" class="btn btn-book" >Book Now</button>
        </div>
    </form>
</div>

<script>
    const elementTbody = document.querySelector('tbody');
    const btnAdd = document.querySelectorAll('.btn-add');

    var serviceList = [];
    const dogServiceContainer = document.getElementById('v-pills-dog');
    const catServiceContainer = document.getElementById('v-pills-cat');
    const otherServiceContainer = document.getElementById('v-pills-other');

    var orderServiceList = []

    const inputNameError = document.querySelector('.inputNameError');
    const inputPhoneError = document.querySelector('.inputPhoneError');
    const inputMailError = document.querySelector('.inputMailError');
    const inputAppointmentError = document.querySelector('.inputAppointmentError');
    const serviceTableError = document.querySelector('.serviceTableError');

    renderListService();

    async function renderListService() {
        try {
            const res = await fetch('/service/book/get-service-list', {
                method: 'POST',
                body: JSON.stringify({ }),
                headers: {'Content-Type': 'application/json'}
            });
            const data = await res.json();
            if (data) {
                if (data.serviceList) {
                    console.log(data.serviceList);
                    serviceList = data.serviceList;
                    var dogServiceHTML = '';
                    var catServiceHTML = '';
                    var otherServiceHTML = '';
                    for (i = 0; i < serviceList.length; i++) {
                        var serviceHTML = '<div class="row service-item p-1" >'
                                                + '<div class="col-md-10 px-1">' + serviceList[i].name + '</div>'
                                                + '<div class="col-md-2 px-1 py-0 d-flex justify-content-center align-items-center">'
                                                    + '<button type="button" class="btn p-0 btn-add" onClick="reply_click(' + '\'' + serviceList[i].name + '\'' + ')">Add</button>'
                                                + '</div>'
                                            + '</div>'
                        
                        if (serviceList[i].category === 'dog-service') {
                            dogServiceHTML += serviceHTML;
                        }
                        else if (serviceList[i].category === 'cat-service') {
                            catServiceHTML += serviceHTML;
                        }
                        else if (serviceList[i].category === 'other-service') {
                            otherServiceHTML += serviceHTML;
                        }
                    }
                    dogServiceContainer.innerHTML = dogServiceHTML;
                    catServiceContainer.innerHTML = catServiceHTML;
                    otherServiceContainer.innerHTML = otherServiceHTML;
                }
                else if (data.error) {
                    console.log('get service list error');
                    console.log(data.error);
                }
            }
            else {
                console.log('get service list failed');
            }
        }
        catch(err) {
            console.log('get service list error');
            console.log(err);
        }
    }

    const render = () => {
        const html = orderServiceList.map((element, index) => (
            `<tr>
            <th scope="row">${index + 1}</th>
            <td>${element.nameService}</td>
            <td>
                <div class="buttons_added border-none">
                    <input aria-label="quantity" class="input-qty" max="10" min="0" type="number" id="${index}" value="${element.amount}" onchange="myFunction(this.value, this.id)">    
                </div>
            </td>
        </tr>`
        ));
        elementTbody.innerHTML = html.join('');
    }

    function reply_click(serviceName)
    {  
        var b = false;
        orderServiceList.forEach((element) => { 
            if(element.nameService == serviceName){
                b = true;
                if(element.amount < 10){
                    element.amount ++;
                    render();
                }
            } 
        } );
        const Data = {
            nameService: serviceName,
            amount: 1
        }
        if(!b){
            orderServiceList.push(Data);
            render();
        }
        console.log(orderServiceList);
    }

    function myFunction(value, id){
        if(value < 1){
            orderServiceList.splice(id, 1);
            render();
        }
        else if(value > 10){
            orderServiceList[id].amount = 10;
            render();
        }
        else{
            orderServiceList[id].amount = Number(value);
        }
        console.log(orderServiceList);
    }


    

    //const formBook = document.querySelector('.form-book');
    const inputName = document.getElementById('name');
    const inputPhone = document.getElementById('phone');
    const inputEmail = document.getElementById('email');
    const inputAppointment = document.getElementById('appointment');
    const inputNote = document.getElementById('comments');
    const btnBook = document.querySelector('.btn-book');
    //const serviceTable = document.querySelector('.service-table');
   // const rows = serviceTable.getElementsByTagName('tr');


    btnBook.addEventListener('click', async ()=>{
        console.log('btn-book clicked');
        inputNameError.textContent = '';
        inputPhoneError.textContent = '';
        serviceTableError.textContent = '';

        const name = inputName.value;
        const phone = inputPhone.value;
        const email = inputEmail.value;
        const appointment = inputAppointment.value;
        const note = inputNote.value;
        var orderValidated = true;

        if (name === '') {
            inputNameError.textContent = 'Vui lòng nhập họ tên';
            orderValidated = false;
        }
        if (phone === '') {
            inputPhoneError.textContent = 'Vui lòng nhập số điện thoại';
            orderValidated = false;
        }
        if (orderServiceList.length < 1) {
            serviceTableError.textContent = 'Vui lòng chọn dịch vụ';
            orderValidated = false;
        }

        if (orderValidated) {
            var services = [];
            for (i = 0; i < orderServiceList.length; i++) {
                var serviceInfo = serviceList.find(element => (element.name === orderServiceList[i].nameService));
                console.log(serviceInfo);
                var service = {
                    service: serviceInfo,
                    type: '',
                    quantity: orderServiceList[i].amount,
                    price: 0,
                    total:  0
                }
                services.push(service);
            }
            console.log(services);
            try {
                const res = await fetch('/service/book', {
                    method: 'POST',
                    body: JSON.stringify({ name, phone, email, appointment, services, note }),
                    headers: {'Content-Type': 'application/json'}
                });
                const data = await res.json();
                console.log(data);
                if (data) {
                    console.log("DK Thanh Cong");
                }
            }
            catch (err) {
                console.log('sign up error');
                console.log(err);
            }
        }
    });
    
    function isNumber(evt) {
        evt = (evt) ? evt : window.event;
        var charCode = (evt.which) ? evt.which : evt.keyCode;
        if ( (charCode > 31 && charCode < 48) || charCode > 57) {
            return false;
        }
        return true;
    }
</script>

